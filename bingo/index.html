<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bingo Arena Mobile Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --primary: #e94560; --bg: #1a1a2e; --card-bg: #16213e; 
            --win: #2ecc71; --accent: #f1c40f; --gold: #ffd700; 
            --money: #27ae60; --loss: #ff4757; 
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg); 
            color: white; 
            margin: 0; 
            height: 100vh;
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        #history-modal { display: none; position: fixed; top:0; left:0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; padding: 20px; }
        .history-card { background: var(--card-bg); width: 100%; max-width: 400px; border-radius: 12px; border: 1px solid var(--accent); display: flex; flex-direction: column; max-height: 80vh; }
        .history-list { overflow-y: auto; padding: 15px; flex-grow: 1; }
        .history-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #0f3460; font-size: 0.85rem; }
        .hist-pos { color: var(--win); }
        .hist-neg { color: var(--loss); }

        .ranking-container { transition: max-height 0.4s ease; overflow: hidden; max-height: 200px; }
        .ranking-collapsed { max-height: 0px !important; }
        .ranking-header { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 8px 15px; border-radius: 8px 8px 0 0; cursor: pointer; }
        #toggle-ranking-btn { background: var(--primary); padding: 4px 10px; font-size: 0.6rem; height: auto; }

        #auth-overlay, #withdraw-modal, #deposit-modal { position: fixed; top:0; left:0; width: 100%; height: 100%; background: rgba(26, 26, 46, 0.98); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        #withdraw-modal, #deposit-modal { display: none; background: rgba(0,0,0,0.9); }
        .auth-card { background: var(--card-bg); padding: 25px; border-radius: 12px; border: 2px solid var(--primary); text-align: center; width: 100%; max-width: 400px; }

        .main-layout { display: flex; flex-direction: column; height: 100dvh; }
        .top-panel { background: var(--card-bg); padding: 4px; border-bottom: 2px solid var(--primary); flex-shrink: 0; z-index: 10; }
        .header-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 6px; }

        .money-display { background: rgba(39, 174, 96, 0.15); border: 1px solid var(--money); border-radius: 8px; padding: 6px; text-align: center; cursor: pointer; }
        .money-value { font-size: 1rem; font-weight: 900; color: #fff; }

        .ball-display { background: #0f3460; border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--accent); }
        #ball { font-size: 2rem; color: var(--accent); font-weight: 900; }
        .ball-pop { animation: pop 0.3s ease; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

        .btn-group-main { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .btn-manual, .btn-auto { height: 40px; }
        .btn-reset { grid-column: span 2; height: 40px; }

        .arena { flex-grow: 1; overflow-y: auto; padding: 15px 10px; display: flex; flex-direction: column; gap: 15px; align-items: center; background: rgba(0,0,0,0.2); }
        .bingo-card { background: var(--card-bg); padding: 10px; border-radius: 12px; border: 1px solid #333; width: 100%; max-width: 320px; }
        .bingo-card.player { border: 2px solid var(--primary); box-shadow: 0 0 15px rgba(233,69,96,0.3); }

        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; }
        .cell { aspect-ratio: 1 / 1; display: flex; align-items: center; justify-content: center; background: #0f3460; border-radius: 5px; font-size: 1rem; font-weight: bold; }
        .cell.marked { background: var(--primary); color: white; }
        .cell.line-win { background: var(--win) !important; color: white !important; box-shadow: 0 0 10px var(--win); z-index: 1; }
        .cell.free { background: #533483; color: var(--accent); }

        .bottom-panel { background: var(--card-bg); padding: 10px; border-top: 2px solid #333; padding-bottom: env(safe-area-inset-bottom); }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        button { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; }
        .btn-util { background: #444; font-size: 0.7rem; }

        #history-grid { display: flex; gap: 5px; overflow-x: auto; padding: 5px; background: #0f3460; border-radius: 4px; margin-top: 6px; min-height: 35px; }
        .hist-ball { min-width: 25px; height: 25px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; }
        
        #money-toast { position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%); z-index: 30000; font-size: 1.5rem; font-weight: 900; opacity: 0; transition: 0.4s; background: rgba(0,0,0,0.9); padding: 20px; border-radius: 15px; border: 2px solid var(--accent); }
        .toast-show { opacity: 1 !important; transform: translate(-50%, -40%) scale(1.1) !important; }
    </style>
</head>
<body>
    <div id="money-toast"></div>

    <div id="auth-overlay">
        <div class="auth-card">
            <h2 id="auth-title">PRIMEIRO ACESSO</h2>
            <p id="auth-instruction">Crie seu PIN de 8 dígitos:</p>
            <input type="tel" id="pass-input" maxlength="8" placeholder="********" style="letter-spacing:8px; font-size:1.8rem; width:100%; text-align:center; padding:10px; margin-bottom:15px; background:#0f3460; color:white; border:none; border-radius:8px;">
            <button id="btn-unlock" style="background:var(--primary); width:100%;">ENTRAR</button>
        </div>
    </div>

    <div id="deposit-modal">
        <div class="auth-card">
            <h2>DEPOSITAR</h2>
            <button onclick="addFunds(10)" style="background:#3498db; width:100%; margin:5px 0;">R$ 10,00</button>
            <button onclick="addFunds(50)" style="background:#3498db; width:100%; margin:5px 0;">R$ 50,00</button>
            <button id="close-dep" style="background:#555; width:100%;">VOLTAR</button>
        </div>
    </div>

    <div class="main-layout">
        <div class="top-panel">
            <div class="header-grid">
                <div class="money-display" id="open-history-trigger">
                    <div style="font-size:0.5rem; color:var(--accent)">SALDO (EXTRATO)</div>
                    <div class="money-value" id="balance">R$ 0,00</div>
                </div>
                <div class="ball-display"><span id="ball">--</span></div>
            </div>
            <div class="btn-group-main">
                <button id="draw-btn" class="btn-manual">SORTEAR</button>
                <button id="auto-btn" class="btn-auto">INICIAR AUTO</button>
                <button id="new-round-btn" class="btn-reset">NOVA RODADA (R$ 6,00)</button>
            </div>
            <div id="history-grid"></div>
        </div>

        <div class="arena" id="arena"></div>

        <div class="bottom-panel">
            <div class="ranking-header" id="header-ranking">
                <span>RANKING AO VIVO</span>
                <button id="toggle-ranking-btn">ESCONDER</button>
            </div>
            <div id="ranking-body" class="ranking-container"><div id="leader-list"></div></div>
            <div class="action-grid">
                <button id="open-dep" class="btn-util">DEPOSITAR</button>
                <button id="btn-logout" class="btn-util">BLOQUEAR</button>
            </div>
        </div>
    </div>

<script>
(function() {
    let drawn = [], players = [], firstLineOut = false, gameOver = false, autoInterval = null;
    let totalBalance = parseFloat(localStorage.getItem('bingo_arena_balance')) || 50.00;
    let costDeducted = false;
    let walletHistory = JSON.parse(localStorage.getItem('bingo_wallet_history') || '[]');
    const ROUND_COST = 6.00, LINE_PRIZE = 12.00, BINGO_PRIZE = 22.00;

    function saveTransaction(desc, value) {
        walletHistory.unshift({ date: new Date().toLocaleString(), desc, value });
        localStorage.setItem('bingo_wallet_history', JSON.stringify(walletHistory.slice(0, 50)));
    }

    function showToast(text, color) {
        const t = document.getElementById('money-toast');
        t.innerText = text; t.style.color = color;
        t.classList.add('toast-show');
        setTimeout(() => t.classList.remove('toast-show'), 2500);
    }

    function updateBalanceDisplay() {
        document.getElementById('balance').innerText = `R$ ${totalBalance.toFixed(2).replace('.', ',')}`;
        localStorage.setItem('bingo_arena_balance', totalBalance);
    }

    function initGame() {
        const arena = document.getElementById('arena');
        arena.innerHTML = ""; players = [];
        const nomes = ["JOÃO", "MARIA", "PEDRO", "ANA", "LUCAS", "CARLA", "BRUNO", "JULIA", "MARCOS", "BEATRIZ"];
        
        for(let i=1; i<=10; i++) {
            let n = [];
            while(n.length < 24) {
                let r = Math.floor(Math.random() * 75) + 1;
                if(!n.includes(r)) n.push(r);
            }
            n.splice(12, 0, 0); // Estrela central (FREE)
            
            let p = { id: i, name: i === 1 ? "VOCÊ" : nomes[i-2], nums: n, marks: 1 };
            players.push(p);
            
            let card = document.createElement('div');
            card.className = `bingo-card ${i===1?'player':''}`;
            card.innerHTML = `<h5 style="margin:5px 0; text-align:center;">${p.name}</h5><div class="grid" id="g-${i}"></div>`;
            arena.appendChild(card);
            
            p.nums.forEach((num, idx) => {
                let cell = document.createElement('div');
                cell.className = 'cell' + (num === 0 ? ' marked free' : '');
                cell.innerText = num === 0 ? '★' : num;
                cell.id = `p${i}-c${idx}`;
                if(num !== 0) cell.setAttribute('data-num', num);
                document.getElementById(`g-${i}`).appendChild(cell);
            });
        }
    }

    function drawBall() {
        if(gameOver || drawn.length >= 75) return;
        
        if(!costDeducted) {
            if(totalBalance < ROUND_COST) {
                alert("Saldo insuficiente!");
                clearInterval(autoInterval);
                return;
            }
            totalBalance -= ROUND_COST;
            costDeducted = true;
            saveTransaction("Entrada Rodada", -ROUND_COST);
            updateBalanceDisplay();
            showToast(`-R$ 6,00`, "#fff");
        }

        let b; do { b = Math.floor(Math.random() * 75) + 1; } while(drawn.includes(b));
        drawn.push(b);
        
        const el = document.getElementById('ball');
        el.innerText = b; el.classList.remove('ball-pop'); void el.offsetWidth; el.classList.add('ball-pop');
        
        let h = document.createElement('div'); h.className = "hist-ball";
        h.innerText = b; document.getElementById('history-grid').prepend(h);

        document.querySelectorAll(`[data-num="${b}"]`).forEach(c => c.classList.add('marked'));
        
        players.forEach(p => { if(p.nums.includes(b)) p.marks++; });
        
        checkWinners();
        updateRanking();
    }

    function checkWinners() {
        players.forEach(p => {
            // VERIFICAÇÃO DE LINHA
            if(!firstLineOut) {
                for(let r=0; r<5; r++) {
                    let hasLine = true;
                    let lineElements = [];
                    for(let c=0; c<5; c++) {
                        let cell = document.getElementById(`p${p.id}-c${r*5+c}`);
                        if(!cell.classList.contains('marked')) hasLine = false;
                        lineElements.push(cell);
                    }
                    if(hasLine) {
                        firstLineOut = true;
                        lineElements.forEach(e => e.classList.add('line-win'));
                        confetti({ particleCount: 50 });
                        if(p.id === 1) {
                            totalBalance += LINE_PRIZE;
                            saveTransaction("Prêmio Linha", LINE_PRIZE);
                            updateBalanceDisplay();
                            showToast(`LINHA! +R$ ${LINE_PRIZE}`, "#2ecc71");
                        } else {
                            showToast(`LINHA: ${p.name}`, "#fff");
                        }
                    }
                }
            }
            
            // BINGO
            if(p.marks === 25 && !gameOver) {
                gameOver = true;
                clearInterval(autoInterval);
                if(p.id === 1) {
                    totalBalance += BINGO_PRIZE;
                    saveTransaction("Prêmio BINGO", BINGO_PRIZE);
                    updateBalanceDisplay();
                    showToast(`BINGO! +R$ ${BINGO_PRIZE}`, "#ffd700");
                } else {
                    showToast(`BINGO: ${p.name}`, "#fff");
                }
                confetti({ particleCount: 150, spread: 70 });
            }
        });
    }

    function updateRanking() {
        let sorted = [...players].sort((a,b) => b.marks - a.marks);
        let list = document.getElementById('leader-list');
        list.innerHTML = "";
        sorted.slice(0, 3).forEach(p => {
            list.innerHTML += `<div class="leader-item ${p.id===1?'me':''}"><span>${p.name}</span><span>${p.marks}/25</span></div>`;
        });
    }

    // Eventos
    document.getElementById('btn-unlock').onclick = () => {
        const input = document.getElementById('pass-input').value;
        const saved = localStorage.getItem('bingo_vault_pass');
        if(!saved) {
            if(input.length === 8) { localStorage.setItem('bingo_vault_pass', input); login(); }
            else alert("PIN deve ter 8 dígitos!");
        } else {
            if(input === saved) login(); else alert("Incorreto!");
        }
    };

    function login() {
        sessionStorage.setItem('auth', '1');
        document.getElementById('auth-overlay').style.display = 'none';
        updateBalanceDisplay();
        initGame();
    }

    document.getElementById('draw-btn').onclick = drawBall;
    document.getElementById('auto-btn').onclick = function() {
        if(autoInterval) { clearInterval(autoInterval); autoInterval = null; this.innerText="INICIAR AUTO"; }
        else { autoInterval = setInterval(drawBall, 800); this.innerText="PAUSAR"; }
    };
    document.getElementById('new-round-btn').onclick = () => { if(confirm("Nova rodada?")) location.reload(); };
    window.addFunds = (v) => { totalBalance += v; saveTransaction("Depósito", v); updateBalanceDisplay(); document.getElementById('deposit-modal').style.display='none'; };
    document.getElementById('open-dep').onclick = () => document.getElementById('deposit-modal').style.display='flex';
    document.getElementById('close-dep').onclick = () => document.getElementById('deposit-modal').style.display='none';
    document.getElementById('btn-logout').onclick = () => { sessionStorage.clear(); location.reload(); };

    if(sessionStorage.getItem('auth')) login();
})();
</script>
</body>
</html>
